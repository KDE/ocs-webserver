<?php
/**
 *  ocs-webserver
 *
 *  Copyright 2016 by pling GmbH.
 *
 *    This file is part of ocs-webserver.
 *
 *    This program is free software: you can redistribute it and/or modify
 *    it under the terms of the GNU Affero General Public License as
 *    published by the Free Software Foundation, either version 3 of the
 *    License, or (at your option) any later version.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU Affero General Public License for more details.
 *
 *    You should have received a copy of the GNU Affero General Public License
 *    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 **/
?>

<style type="text/css">
  .pploadajax .btn{
    padding: 3px 5px;
  }
  .pploadajax td{
    padding: 3px;
  }
  
</style>

  <!-- ppload -->
         <?php if ($this->product->ppload_collection_id): ?>
             <?php
             $helperCatXdgType = new Default_View_Helper_CatXdgType();
             $xdgType = $helperCatXdgType->catXdgType($this->product->project_category_id);           
             ?>

             <article>
                <div style="border: 1px solid #ddd; height: 300px; width: 100%; display: flex; align-items: center;">
                      <h1 style="flex:1; text-align: center;   ">  Welcome to download !</h1>
                </div>                 
             </article>

                 <article style="font-size: smaller;" class="pploadajax">                  
                     <div data-ppload-api-uri="<?= PPLOAD_API_URI ?>"
                          data-ppload-collection-id="<?= $this->product->ppload_collection_id ?>"
                          data-xdg-type="<?= $xdgType ?>">
                
                         <!--table-bordered-->
                         <table class="table table-ocs-file" data-ppload-files-ajax="" style="width: 1200px; ">
                             <thead>
                             <tr>
                                 <th><?= $this->translate('File (click to download)'); ?></th>
                                 <th><?= $this->translate('Version'); ?></th>
                                 <th><?= $this->translate('Description'); ?></th>
                            
                                 <th><?= $this->translate('Packagetype'); ?></th>
                             
                                 <th style="text-align: right"><?= $this->translate('Downloads'); ?></th>
                                 <th><?= $this->translate('Date'); ?></th>

                                 <th style="text-align: right"><?= $this->translate('Filesize'); ?></th>
                                
                                 <th style="text-align: right">DL</th>
                                  <th style="text-align: right;white-space:nowrap"><?= $this->translate('OCS-Install'); ?>
                                     <a href="#modal-installation-instructions" role="button" data-toggle="modal"><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span></a>
                                 </th>
                               
                             </tr>
                             </thead>
                             <tbody></tbody>
                             <tfoot>
                             </tfoot>
                         </table>


                     </div>
                 </article>


             


             <script type="text/javascript">

                 $(function () {
                     var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}};

                     var $pploadCollection = $('div[data-ppload-collection-id]');                     
                     var pploadApiUri = $pploadCollection.attr('data-ppload-api-uri');
                     var hasFilesPanelOpened = false;

                     function keysrt(key, asc) {
                         if(asc) {
                              return function(a,b){
                               if (a[key] > b[key]) return 1;
                               if (a[key] < b[key]) return -1;
                               return 0;
                              }
                         } else {
                             return function(a,b){
                                   if (a[key] < b[key]) return 1;
                                   if (a[key] > b[key]) return -1;
                                   return 0;
                             }
                         }
                    }

                 


                     function getPploadFiles(page) {
                          
                         var collectionId = $pploadCollection.attr('data-ppload-collection-id');
                         if (!page) {
                             page = 1;
                         }
                         $.ajax({
                             url: pploadApiUri + 'files/index',
                             type: 'GET',
                             data: {
                                 format: 'json',
                                 ignore_status_code: 1,
                                 status: 'all',
                                 collection_id: collectionId,
                                 perpage: 1000,
                                 page: page
                             },
                             dataType: 'json',
                             success: function (data, textStatus, jqXHR) {                                 
                                 var isPlayable = false;
                                 var fileSizeSum = 0;

                                 var downloaded_count_total = 0;
                                 var firstRow = true;

                                var myArray = $.map(data.files, function(entry) {
                                    return entry;
                                });

                                //myArray = myArray.sortOn('active');
                                myArray.sort(keysrt('active'), false);
                                myArrayActive = [];
                                myArrayInactive = [];
                                $.each(myArray, function () {
                                        if(this.active == '1') {
                                                myArrayActive.push(this);
                                        } else {
                                                myArrayInactive.push(this);
                                        }
                                });

                                //sort
                                myArrayActive.sort(keysrt('created_timestamp'), false);
                                myArrayInactive.sort(keysrt('created_timestamp'), false);

                                var oldestFileId = null;
                                //Active Files
                                 $.each(myArrayActive, function () {
                                    if(firstRow) {
                                        //this.downloaded_count = parseInt(this.downloaded_count) + parseInt(<?= $this->product->count_downloads_hive?>);
                                        oldestFileId = this.id;
                                        firstRow = false;
                                    }

                                    if(this.id < oldestFileId) {
                                            oldestFileId = this.id;
                                    }

                                    count_downloads = this.downloaded_count || 0;
                                    downloaded_count_total = downloaded_count_total+parseInt(count_downloads);

                                    //downloadlink is now: domain/api/files/download/id/ID/s/TOKEN/t/TIMESTAMP/FILE_NAME/u/USERID
                                    var hash = '<?= $this->download_hash ?>';
                                    var timetamp = '<?= $this->download_timestamp ?>';
                                    var userid = '<?= $this->product->member_id?>';

                                    var downloadUrl = "https://<?= $_SERVER["SERVER_NAME"]?>/p/<?= $this->product->project_id ?>/startdownload?file_id=" + this.id + "&file_name=" + this.name + "&file_type=" + this.type + "&file_size=" + this.size + "&url=" + encodeURIComponent(pploadApiUri + 'files/downloadfile/id/' + this.id + '/s/' + hash + '/t/' + timetamp + '/u/' + userid + '/' + this.name);
                                    var downloadLink = '<a href="' + downloadUrl + '" id="data-link-ajax' + this.id + '">' + this.name + '</a>';

                                    /*
                                    var fileNameBtnLink = this.name;
                                    if(fileNameBtnLink.length > 25) {
                                        fileNameBtnLink = fileNameBtnLink.substring(0,22) + '...';
                                    }*/
                                    var downloadBtnLink = downloadUrl;
                                    var downloadLinkFilename = shortFilename(this.name);

                                    if(this.active == '0') {
                                        downloadLink = this.name;
                                    }
                                    var link = '';

                                    var fileDescription = '';
                                    if (this.description) {
                                        fileDescription = this.description;
                                    }
                                     var licenseId = '';
                                     var license = '';
                                     var packagetypeId = '';
                                     if (this.tags) {
                                         fileTags = this.tags;

                                         $.each(fileTags.split(','), function () {

                                             if(this.indexOf("##")==-1) {
                                              var tagStr = this.split('-');
                                              if (tagStr.length == 2 && tagStr[0] == 'os') {
                                                  osId = tagStr[1];
                                              } else if (tagStr.length == 2 && tagStr[0] == 'licensetype') {
                                                  licenseId = tagStr[1];
                                              } else if (tagStr.length == 2 && tagStr[0] == 'packagetypeid') {
                                                  packagetypeId = tagStr[1];
                                              }
                                             } else {
                                              var tagStr = this.split('##');
                                              if (tagStr.length == 2 && tagStr[0] == 'link') {
                                                  link = tagStr[1];
                                              } else if (tagStr.length == 2 && tagStr[0] == 'license') {
                                                  license = tagStr[1];
                                                  license = Base64.decode(license);
                                              } else if (tagStr.length == 2 && tagStr[0] == 'packagetypeid') {
                                                  packagetypeId = tagStr[1];
                                              }
                                             }
                                          
                                         });
                                     }

                                     var ocsUrl = '';
                                     if (typeof link !== 'undefined' && link) {
                                         ocsUrl = generateOcsUrl(
                                             decodeURIComponent(link),
                                             $pploadCollection.attr('data-xdg-type')
                                         );
                                     } else if (!link) {
                                         ocsUrl = generateOcsUrl(
                                             downloadUrl,
                                             $pploadCollection.attr('data-xdg-type'),
                                             this.name
                                         );
                                     }

                                     var installButton = '';
                                     var installLink = '';
                                     var installLinkFilename = '';

                                     if ( ocsUrl) {
                                            if(this.active && this.ocs_compatible == 1){
                                                installButton = '<a href="' + ocsUrl + '" class="btn btn-native btn-min-width">Install</a>';
                                                installLink = ocsUrl;
                                                installLinkFilename = shortFilename(this.name);

                                            } else {
                                                installButton = '<a href="#" class="btn btn-min-width disabled">INCOMPATIBLE</a>';
                                                installLink = '';
                                                installLinkFilename = '';
                                            }
                                     }

                                    //if(this.active == '1') {
                                    var greyText = ' class="activerows"';
                                    if(this.active == '0') {
                                           greyText = ' style="color: #ccc;"';
                                    }

                                    var downloadButton = '';
                                    var username = '<?= $this->product->username?>';
                                    downloadButton = '<a href="'+downloadUrl+'" data-username="'+username+'" class="btn btn-native btn-min-width opendownloadfile" ><img src="/images/system/download.svg" alt="download" style="width:20px; height:20px"></a>' ;

                                    if(this.version==null) {version = '';} else{version = this.version;}
                                    var isExternLink = false;
                                    if ((typeof link != 'undefined') && (link != "")) {
                                       isExternLink = true;
                                    }



                                    var mnt = moment(this.created_timestamp);

                                        $pploadCollection.find('table[data-ppload-files-ajax] tbody').append(
                                            '<tr data-ppload-file-id="' + this.id + '"' + greyText + '>'
                                            + '<td>' + downloadLink + '</td>'
                                            + '<td>' + version + '</td>'
                                            + '<td>' + fileDescription + '</td>'                                            
                                            + '<td>'
                                            + '<select id="data-select-packagetype-ajax' + this.id + '" data-packagetype-id="" name="packagetype" class="form-control input-sm" style="width: 200px;">'
                                            + '<option value=\"\"></option>'
                                            + '<option value=\"2\">Android (APK)</option>'
                                            + '<option value=\"1\">AppImage</option>'
                                            + '<option value=\"9\">Arch</option>'
                                            + '<option value=\"5\">Debian</option>'
                                            + '<option value=\"8\">Electron-Webapp</option>'
                                            + '<option value=\"7\">Flatpak</option>'
                                            + '<option value=\"10\">open/Suse</option>'
                                            + '<option value=\"3\">OS X compatible</option>'
                                            + '<option value=\"11\">Redhat</option>'
                                            + '<option value=\"6\">Snappy</option>'
                                            + '<option value=\"12\">Source Code</option>'
                                            + '<option value=\"4\">Windows executable</option>'
                                            + '</select><span id="file-tag-packagetype-ajax'+this.id+'">'
                                            + '</td>'

                                            + '<td style="text-align: right"><span id="download_counter_' + this.id + '">' + count_downloads + '</td>'
                                            + '<td>' +mnt.format('YYYY-MM-DD') + '</td>'
                                            + '<td style="text-align: right">' + humanFileSize(this.size,false) + '</td>'
                                            + '<td style="text-align: right; ">' + downloadButton+ '</td>'
                                            + '<td style="text-align: right; ">' + installButton + '</td>'                                            
                                           
                                            + '</tr>'
                                        );

                                    

                                        if ((typeof osId != 'undefined') && (osId != "")) {
                                            $("#data-updatepploadfile" + this.id + " option[value='" + osId + "']").attr('selected', 'selected');
                                            $os = $("#data-updatepploadfile" + this.id + " option[value='" + osId + "']").text();
                                            //alert("Text: " + $os);
                                            $("#data-updatepploadfile" + this.id).hide();
                                            $("#file-tag-os" + this.id).text($os);
                                        }

                                        if ((typeof licenseId != 'undefined') && (licenseId != "")) {
                                            $("#data-select-license" + this.id + " option[value='" + licenseId + "']").attr('selected', 'selected');
                                            $licenseIdText = $("#data-select-license" + this.id + " option[value='" + licenseId + "']").text();
                                            $("#data-select-license" + this.id).hide();
                                            $("#file-tag-license" + this.id).text($licenseIdText);
                                        } else {
                                         $("#data-select-license" + this.id).hide();
                                        }

                                        if ((typeof license != 'undefined') && (license != "")) {
                                            $("#file-tag-license-text" + this.id).text(license);
                                        }

                                        $("#data-select-license" + this.id).hide();

                                        if ((typeof packagetypeId != 'undefined') && (packagetypeId != "")) {
                                            $("#data-select-packagetype-ajax" + this.id + " option[value='" + packagetypeId + "']").attr('selected', 'selected');
                                            $packagetypeIdText = $("#data-select-packagetype-ajax" + this.id + " option[value='" + packagetypeId + "']").text();
                                            $("#data-select-packagetype-ajax" + this.id).hide();                                         
                                            $("#file-tag-packagetype-ajax" + this.id).text($packagetypeIdText);

                                        } else {
                                         $("#data-select-packagetype-ajax" + this.id).hide();
                                        }

                                        console.log($("#data-select-packagetype-ajax" + this.id));
                                        $("#data-select-packagetype-ajax" + this.id).hide();

                                        if ((typeof this.ocs_compatible != 'undefined') && (this.ocs_compatible != "") && this.ocs_compatible == 1) {
                                            $("#data-checkbox-compatible-" + this.id).attr('checked', 'checked');
                                        }


                                        if (isExternLink) {
                                            $fileserverLink = $("#data-link-ajax" + this.id).attr('href');
                                            $("#data-link-ajax" + this.id).attr('href', decodeURIComponent(link));
                                            $("#data-link-ajax" + this.id).attr('data-link-ajax-org', $fileserverLink);

                                            $("#data-link-ajax" + this.id).attr('target','_blank');
                                            $("#data-link-ajax" + this.id).html($("#data-link-ajax" + this.id).html() + " (External Link)");

                                            $("#data-link-ajax" + this.id).click(function (event) {
                                                event.preventDefault();
                                                $fileserverLink = $(this).attr('data-link-ajax-org');
                                                window.open($fileserverLink, '_blank');
                                            });


                                            $fileserverLink = $("#data-link-ajax-dl" + this.id).attr('href');
                                            $("#data-link-ajax-dl" + this.id).attr('href', decodeURIComponent(link));
                                            $("#data-link-ajax-dl" + this.id).attr('data-link-ajax-org', $fileserverLink);

                                            $("#data-link-ajax-dl" + this.id).attr('target','_blank');

                                            $("#download-link-filename" + this.id).html($("#download-link-filename" + this.id).html() + " (External Link)");

                                            $("#data-link-ajax-dl" + this.id).click(function (event) {
                                                event.preventDefault();
                                                $fileserverLink = $(this).attr('data-link-ajax-org');
                                                window.open($fileserverLink, '_blank');
                                            });

                                            $("#install-link-filename" + this.id).html($("#install-link-filename" + this.id).html() + " (External Link)");
                                        }


                                        $compatibleCheckbox = $("#data-checkbox-compatible-" + this.id);

                                        if(this.active == '0') {
                                            $compatibleCheckbox.prop('disabled', 'disabled');
                                        }

                                     

                                        //fileSizeSum += parseInt(this.size);
                                        if(parseInt(this.size)>0) {
                                            fileSizeSum += roundFileSizeInMB(parseInt(this.size));
                                        }

                                    //if (!isExternLink)
                                    //{
                                       //fileSizeSum += roundFileSizeInMB(parseInt(this.size));
                                    //}


                                    if (this.type == 'audio/mpeg' || this.type == 'application/ogg') {
                                        isPlayable = true;
                                    }

                                    //}

                                 });

                                 //
                                 //Inactive Fiels
                                 //
                                 $.each(myArrayInactive, function () {
                                    if(null == oldestFileId) {
                                            oldestFileId = this.id;
                                    }

                                    if(this.id < oldestFileId) {
                                            oldestFileId = this.id;
                                    }

                                    cout_downloads = this.downloaded_count || 0;

                                    downloaded_count_total = downloaded_count_total+parseInt(cout_downloads);

                                    downloadLink = this.name;

                                     var fileDescription = '';
                                     if (this.description) {
                                         fileDescription = this.description;
                                     }

                                     var licenseId = '';
                                     var license = '';
                                     if (this.tags) {
                                         fileTags = this.tags;
                                         $.each(fileTags.split(','), function () {

                                             if(this.indexOf("##")==-1) {
                                              var tagStr = this.split('-');
                                              if (tagStr.length == 2 && tagStr[0] == 'os') {
                                                  osId = tagStr[1];
                                              } else if (tagStr.length == 2 && tagStr[0] == 'licensetype') {
                                                  licenseId = tagStr[1];
                                              } else if (tagStr.length == 2 && tagStr[0] == 'packagetypeid') {
                                                  packagetypeId = tagStr[1];
                                              }
                                             } else {
                                              var tagStr = this.split('##');
                                              if (tagStr.length == 2 && tagStr[0] == 'link') {
                                                  link = tagStr[1];
                                              } else if (tagStr.length == 2 && tagStr[0] == 'license') {
                                                  license = tagStr[1];
                                                  license = Base64.decode(license);
                                              } else if (tagStr.length == 2 && tagStr[0] == 'packagetypeid') {
                                                  packagetypeId = tagStr[1];
                                              }
                                             }
                                             /*else if (tagStr.length == 2 && tagStr[0] == 'package') {
                                              packageId = tagStr[1];
                                              }
                                              else if (tagStr.length == 2 && tagStr[0] == 'arch') {
                                              archId = tagStr[1];
                                              }
                                              else if (tagStr.length == 2 && tagStr[0] == 'device') {
                                              deviceId = tagStr[1];
                                              }*/
                                         });
                                     }

                                     //if(this.active == '1') {
                                       var greyText = ' class="inactiverows" style="color: #ccc; display:none;"';

                                       if(this.version==null) {version = '';} else{version = this.version;}

                                         var isExternLink = false;
                                         if ((typeof link != 'undefined') && (link != "")) {
                                            isExternLink = true;
                                            downloadLink = '<a href="' + decodeURIComponent(link) + '" id="data-link-ajax' + this.id + '" style="color: #ccc;">' + this.name + '</a>';
                                         }
                                         var mnt = moment(this.created_timestamp);
                                         $pploadCollection.find('table[data-ppload-files-ajax] tbody').append(
                                            '<tr' + greyText + '>'
                                            + '<td>' + downloadLink + '</td>'
                                                + '<td>' + version + '</td>'
                                            + '<td>' + fileDescription + '</td>'
                                                + '<td>'
                                                + '<select id="data-select-packagetype-ajax' + this.id + '" data-packagetype-id=" name="packagetype" class="form-control input-sm" style="width: 200px;">'
                                                + '<option value=\"\"></option>'
                                                + '<option value=\"2\">Android (APK)</option>'
                                                + '<option value=\"1\">AppImage</option>'
                                                + '<option value=\"9\">Arch</option>'
                                                + '<option value=\"5\">Debian</option>'
                                                + '<option value=\"8\">Electron-Webapp</option>'
                                                + '<option value=\"7\">Flatpak</option>'
                                                + '<option value=\"10\">open/Suse</option>'
                                                + '<option value=\"3\">OS X compatible</option>'
                                                + '<option value=\"11\">Redhat</option>'
                                                + '<option value=\"6\">Snappy</option>'
                                                + '<option value=\"12\">Source Code</option>'
                                                + '<option value=\"4\">Windows executable</option>'
                                                + '</select><span id="file-tag-packagetype-ajax'+this.id+'">'
                                                + '</td>'
                                            
                                            + '<td style="text-align: right"><span id="download_counter_' + this.id + '">' + cout_downloads + '</td>'
                                            + '<td>' +mnt.format('YYYY-MM-DD')  + '</td>'
                                            + '<td style="text-align: right">' + humanFileSize(this.size,false) + '</td>'
                                                + '<td></td>'
                                                + '<td></td>'
                                            + '</tr>'
                                         );

                                         if ((typeof osId != 'undefined') && (osId != "")) {
                                             $("#data-updatepploadfile" + this.id + " option[value='" + osId + "']").attr('selected', 'selected');
                                             $os = $("#data-updatepploadfile" + this.id + " option[value='" + osId + "']").text();
                                             //alert("Text: " + $os);
                                             $("#data-updatepploadfile" + this.id).hide();
                                             $("#file-tag-os" + this.id).text($os);
                                         }

                                         if ((typeof licenseId != 'undefined') && (licenseId != "")) {
                                             $("#data-select-license" + this.id + " option[value='" + licenseId + "']").attr('selected', 'selected');
                                             $licenseIdText = $("#data-select-license" + this.id + " option[value='" + licenseId + "']").text();
                                             $("#data-select-license" + this.id).hide();
                                             $("#file-tag-license" + this.id).text($licenseIdText);
                                         } else {
                                          $("#data-select-license" + this.id).hide();
                                         }

                                         $("#data-select-license" + this.id).hide();

                                         if ((typeof license != 'undefined') && (license != "")) {
                                             $("#file-tag-license-text" + this.id).text(license);
                                         }

                                             if ((typeof packagetypeId != 'undefined') && (packagetypeId != "")) {
                                             $("#data-select-packagetype-ajax" + this.id + " option[value='" + packagetypeId + "']").attr('selected', 'selected');
                                             $packagetypeIdText = $("#data-select-packagetype-ajax" + this.id + " option[value='" + packagetypeId + "']").text();
                                             $("#data-select-packagetype-ajax" + this.id).hide();
                                             $("#file-tag-packagetype-ajax" + this.id).text($packagetypeIdText);
                                         } else {
                                          $("#data-select-packagetype-ajax" + this.id).hide();
                                         }

                                         $("#data-select-packagetype-ajax" + this.id).hide();



                                         if (isExternLink) {
                                            //$("#data-link-ajax" + this.id).attr('href', decodeURIComponent(link));
                                                $("#data-link-ajax" + this.id).attr('target','_blank');
                                            $("#data-link-ajax" + this.id).html($("#data-link-ajax" + this.id).html() + " (External Link)");
                                         }



                                        //fileSizeSum += parseInt(this.size);
                                            if(parseInt(this.size)>0) {
                                                fileSizeSum += roundFileSizeInMB(parseInt(this.size));
                                            }
                                         //if (!isExternLink)
                                         //{
                                            //fileSizeSum += roundFileSizeInMB(parseInt(this.size));
                                         //}


                                         if (this.type == 'audio/mpeg' || this.type == 'application/ogg') {
                                             isPlayable = true;
                                         }

                                     //}

                                 });

 
                                 //add old download counter
                                 downloaded_count_total += parseInt(<?= $this->product->count_downloads_hive?>);

                                 //add old download counter to oldest file
                                 var fileCount = $('#download_counter_'+ oldestFileId).html();
                                 var oldNewCounter = parseInt(fileCount) + parseInt(<?= $this->product->count_downloads_hive?>);
                                 $('#download_counter_'+ oldestFileId).html(oldNewCounter);



                                //$('#downloadscnt').html(downloaded_count_total);

                                 $pploadCollection.find('table[data-ppload-files-ajax] tfoot').append(
                                     '<tr>'
                                     + '<th colspan="4">' + myArrayActive.length + ' <?= $this->translate("files")?> (<span style="color: #ccc;" ><a style="cursor:pointer" onclick="fnToggleInactiveFiles();return false;">'+myArrayInactive.length+' archived</a></span>)</th>'
                                     + '<th style="text-align: right">' + downloaded_count_total + '</th>'
                                     + '<th></th>'
                                    + '<th style="text-align: right">' + fileSizeSum.toFixed(2) + ' MB</th>'
                                     //+ '<th style="text-align: right">' + humanFileSize(fileSizeSum) + '</th>'
                                     + '<th></th>'
                                       + '<th></th>'
                                     + '</tr>'
                                 );

                                 $pploadCollection.find('a[data-ppload-download-link]').attr(
                                     'href',
                                     pploadApiUri + 'collections/download/id/' + collectionId
                                 );

                        


                                 if (data.pagination.next) {
                                     getPploadFiles(data.pagination.next);
                                 }

                             },
                             error: function (jqXHR, textStatus, errorThrown) {

                                 

                             }
                         });
                     }

                     function generateOcsUrl(url, type, filename) {
                         if (!url || !type) {
                             return '';
                         }
                         if (!filename) {
                             filename = url.split('/').pop().split('?').shift();
                         }
                         return 'ocs://install'
                            + '?url=' + encodeURIComponent(url)
                            + '&type=' + encodeURIComponent(type)
                            + '&filename=' + encodeURIComponent(filename);
                     }


                   

                    function shortFilename(filename) {
                        var returnString = filename;
                        if(filename.length > 25) {
                            var name = filename.substring(0,22);
                            var fileExt = filename.split('.').pop();
                            if(fileExt.length>3) {
                                name = name.substring(0,(25-fileExt.length));
                            }
                            returnString = name + '...' + fileExt;
                        }
                        return returnString;
                    }


                     function roundFileSizeInMB(bytes)
                     {
                        // min size 0.01MB
                        if(bytes>0)
                        {
                            var size = (bytes / 1048576).toFixed(2);
                            if(size == '0.00')
                            {
                                return Number('0.01');
                            }else
                            {
                                return Number(size);
                            }
                        }
                     }



                      fnToggleInactiveFiles = function(){
                           $('.inactiverows').toggle();
                      };



                     function humanFileSize(bytes,isExternLink) {
                         if(isExternLink) return '----';
                         if(bytes>0)
                         {
                             var size = '';
                             size = (bytes / 1048576).toFixed(2);
                             if(size == '0.00')
                             {
                                return '0.01 MB';
                             }else
                             {
                                return size+' MB';
                             }
                         }
                         else
                         {
                            return '0.00 MB';
                         }
                     }

                     function humanFileSize_(bytes) {
                         if(bytes>0)
                         {
                             var size = '';
                             size = (bytes / 1048576).toFixed(2);
                             

                             if(size == '0.00')
                             {
                                return '0.01 MB';
                             }else
                             {
                                return size+' MB';
                             }
                         }
                         else
                         {
                            return '0.00 MB';
                         }
                     }

                     //$('a[href="#files-panel"][data-toggle="tab"]').on('click', function () {
                     if (!hasFilesPanelOpened) {
                         getPploadFiles();
                         hasFilesPanelOpened = true;


                     }
                     //});

                 });

                $(function() {
                    $('#modal-installation-instructions').on('hidden.bs.modal', function (e) {
                              var iframe = document.getElementById('iframeInstallInstruction');
                              var leg=$(iframe).attr("src");
                              $(iframe).attr("src","");
                        });

                    $('#modal-installation-instructions').on('show.bs.modal', function (e) {
                              var iframe = document.getElementById('iframeInstallInstruction');
                              var leg=$(iframe).attr("src");
                              $(iframe).attr("src","https://opendesktop.github.io/ocs-url/opendesktoporg-help.html");
                        });

                });
             </script>
         <?php endif; ?>
         <!-- /ppload -->
