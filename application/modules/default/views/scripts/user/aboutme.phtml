<?php
/**
 *  ocs-webserver
 *
 *  Copyright 2016 by pling GmbH.
 *
 *    This file is part of ocs-webserver.
 *
 *    This program is free software: you can redistribute it and/or modify
 *    it under the terms of the GNU Affero General Public License as
 *    published by the Free Software Foundation, either version 3 of the
 *    License, or (at your option) any later version.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU Affero General Public License for more details.
 *
 *    You should have received a copy of the GNU Affero General Public License
 *    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 **/

$helperBuildMemberUrl = new Default_View_Helper_BuildMemberUrl();
$helperImage = new Default_View_Helper_Image();
$helpTruncate = new Default_View_Helper_Truncate();
$this->headTitle($this->member->username . ' - ' . $_SERVER['HTTP_HOST'], 'SET');
$this->doctype(Zend_View_Helper_Doctype::XHTML1_RDFA);
$desc=  isset($this->mainProject->description) ? nl2br(strip_tags($this->mainProject->description)): $this->member->username;
$this->headMeta()->setName('description',
    $helpTruncate->truncate($desc, 200, '...', false, true));
$this->headMeta()->setName('title',
    $this->member->username . ' - ' . $_SERVER['HTTP_HOST']);

$this->headMeta()->appendProperty('og:url', $helperBuildMemberUrl->buildMemberUrl($this->member->username));
$this->headMeta()->appendProperty('og:type', 'website');
$this->headMeta()->appendProperty('og:title', $this->member->username);
$this->headMeta()->appendProperty('og:description',
    $helpTruncate->truncate($desc, 200, '...', false, true));
$this->headMeta()->appendProperty('og:image',
    $helperImage->Image($this->member->profile_image_url,array('width' => 110, 'height' => 110, 'crop' => 2)));


$helperFetchMainCategories = new Default_View_Helper_FetchMainCategories();
$helperRatingWidget = new Default_View_Helper_PrintRatingWidget();
$categories = $helperFetchMainCategories->fetchMainCategories();
$helperAddDefaultScheme = new Default_View_Helper_AddDefaultScheme();
$helperBuildProductUrl = new Default_View_Helper_BuildProductUrl();
$helperTruncate = new Default_View_Helper_Truncate();
$helperImage = new Default_View_Helper_Image();
$helperPrintDate = new Default_View_Helper_PrintDate();
$textCountryCity = $this->member->city;
$textCountryCity .= $this->member->country ? ', ' . $this->member->country : '';
$helperMemberScore = new Default_View_Helper_FetchMemberScore();
$isSupporter = $this->stat['donationIssupporter'];

$url_gitlab = Zend_Registry::get('config')->settings->client->default->url_gitlab;
$url_forum = Zend_Registry::get('config')->settings->client->default->url_forum;

$memberProfile = $helperImage->Image($this->member->profile_image_url,array('width' => 110, 'height' => 110, 'crop' => 2));

?>
<style type="text/css">
/* ADD THIS TO CSS */
div#preloaded-images {
   position: absolute;
   overflow: hidden;
   left: -9999px; 
   top: -9999px;
   height: 1px;
   width: 1px;
}
</style>
<!-- ADD THIS TO XHTML -->
<div id="preloaded-images">
   <img src="<?php echo $memberProfile?>" width="1" height="1" alt="Image 01" />
</div>

    <main class="about-me-page">

        <section class="head-wrap">

            <!-- HEADER -->

            <section class="wrapper">
                
 
                <!-- banner -->

                <section class="header">

                    <!-- about me summary -->
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12 summary" style=" padding-top:65px" >
                        <article class="well" style="width: 100%;">
                            <div class="about-title">
                                <figure class="relative inline profile-image-container">
                                    <?php if( $isSupporter) { ?><span class="supporter-badge">S</span>                                                  
                                    <?php }?>                                                                        
                                    <img src="<?php echo $memberProfile ; ?>"
                                         alt="profile-image"
                                         width="110"
                                         height="110">

                                     <?php if( $this->member->roleId==Default_Model_DbTable_Member::ROLE_ID_MODERATOR) { ?>
                                            <div class="mod-badge">MODERATOR</div>                                                  
                                    <?php }?>
                                </figure>
                                
                                <h1><span class="lightblue"><?php echo $this->member->username; ?></span>    
                               </h1>
                                <?php if($this->member->firstname ) :?>
                                <span class="glyphicon glyphicon-user"></span>
                                <span class="text"><?php echo $this->member->firstname; ?>&nbsp;<?php echo $this->member->lastname; ?> </span>
                                <?php endif; ?>

                               <?php if($textCountryCity):?>
                                <span class="glyphicon glyphicon-map-marker"></span>
                                <span class="text"><?php echo $textCountryCity ?></span>
                               <?php endif; ?>

                           
                            </div>
                            <div class="about-footer">                                                            
                             
                               

                            <div class="col-container" >
                            <div class="details stat" >
                                <h3>Statistics</h3>
                                <div  class="statContent" >
                                    <div class="row ">
                                       <span class="cnt"><?=$this->stat['cntProducts']?> </span> Products
                                    </div>
                                    <div class="row">
                                       <span class="cnt"><?=$this->stat['cntComments']?> </span> Comments
                                    </div>

                                   
                                    <div class="row">
                                       Plinged <span class="cnt"> <?=$this->stat['cntPlingsHeGave']?> </span>Products
                                    </div>
                                    <div class="row">
                                       Got <span class="cnt"> <?=$this->stat['cntPlingsHeGot']?> </span><img  src="/images/system/pling-btn-active.png" style="width:20px; height:20px" />
                                    </div>
                               

                                    <div class="row">
                                       Likes <span class="cnt"> <?=$this->stat['cntLikesHeGave']?> </span>Products
                                    </div>
                                    <div class="row">
                                       Got <span class="cnt"> <?=$this->stat['cntLikesHeGot']?> </span>Likes <i class="fa fa-heart" style="color:#8e44ad" aria-hidden="true"></i>

                                    </div>
                                   
                                  <?php 
                                      if($this->stat['donationMax'] !=null && !$isSupporter){ // inactive supporter
                                  ?>
                                   <div class="row">
                                     <span class="cnt">Inactive supporter since: <?=$helperPrintDate->printDate(date('Y-m-d H:i:s', strtotime($this->stat['donationMax'] . ' +1 year')))?></span> 
                                  </div>
                                  <?php } ?>

                                    <?php 
                                        if($isSupporter){
                                    ?>                                     
                                     <div class="row">                                     
                                       <span>Supporter since: <?=$helperPrintDate->printDate($this->stat['donationMin'])?> </span> 
                                    </div>
                                      <div class="row">                                     
                                       <span>Supporter until: <?=$helperPrintDate->printDate(date('Y-m-d H:i:s', strtotime($this->stat['donationMax'] . ' +1 year')))?> </span> 
                                    </div>                                     
                                    <?php } ?>
                                     <div class="row">                                     
                                       <span class="">Last time active : <?=$helperPrintDate->printDate($this->stat['userLastActiveTime'])?> </span> 
                                    </div>
                                     <div class="row">                                                                            
                                        <span class="text">Joined : <?=$helperPrintDate->printDate($this->member->created_at);?></span>                                       
                                    </div>
                                    
                                   
                                </div>
                            </div>
                        </div>

                             
                            </div>
                            <?php
                            $helperUserRole = new Backend_View_Helper_UserRole();
                            $userRoleName = $helperUserRole->userRole();
                            ?>

                            <?php if (Default_Model_DbTable_MemberRole::ROLE_NAME_ADMIN == $userRoleName) : ?>
                                <div class="pull-right">
                                <span class="page-views">
                                <a id="linktohive" target="_blank" href="http://cp1.hive01.com/usermanager/search.php?username=<?= $this->member->username ?>">link to hive</a>
                                <a id="delete-this" href="/backend/user/delete?member_id=<?= $this->member->member_id ?>">delete user</a>
                                </span>
                                <br>
                                <span class="page-views" style="color: red;">
                                    <input type="checkbox" id="pling-excluded-checkbox" <?php echo $this->member->pling_excluded == 1 ? ' checked=\'checked\' ' : ''; ?> />  user-pling-excluded
                                </span>
                                <script>
                                    $('#delete-this').on('click', function (event) {

                                        event.stopPropagation();
                                        var target = $(this).attr('href');

                                        $.ajax({
                                            url: target,
                                            success: function (results) {
                                                alert('User deleted successfully');
                                            },
                                            error: function() {
                                                alert('Service is temporarily unavailable.');
                                            }
                                        });

                                        return false;
                                    });
                                    
                                    
                                    $('#pling-excluded-checkbox').on('click', function (event) {
                                        event.stopPropagation();
                                        var status = 0;
                                        if (this.checked) {
                                            status = 1;
                                        } else {
                                            status = 0;
                                        }

                                        var target = "/backend/member/doexclude?member_id=<?= $this->member->member_id ?>&pling_excluded=" + status;
                                        $.ajax({
                                            url: target,
                                            success: function (results) {
                                                if (status == 0) {
                                                    alert('Member was successfully included for plinging');
                                                    $('#pling-excluded-checkbox').prop("checked", false);

                                                } else {
                                                    alert('Member was successfully excluded for plinging');
                                                    $('#pling-excluded-checkbox').prop("checked", true);

                                                }

                                            },
                                            error: function () {
                                                alert('Service is temporarily unavailable.');
                                            }
                                        });

                                        return false;
                                    });
                                </script>
                                </div>
                            <?php endif; ?>
                        </article>
                    </div>
                    <!-- /about me summary -->

                </section>

                <!-- /banner -->

            </section>

            <!-- /HEADER -->

        </section>

        <section class="body-wrap">

            <section class="wrapper">
               

                <!-- PAGE BODY -->

                <section class="product-page about-me full-width">

                    <!-- page content -->

                    <div class="col-md-8 col-lg-8 col-sm-8 col-xs-12 about-me-details">

                        <!-- tabs nav -->
                        <div class="pling-nav-tabs">
                        <ul class="nav nav-tabs" role="tablist">
                            <li role="presentation" class="active">
                                <a href="#user-aboutme" data-toggle="tab" role="tab"  aria-controls="user-aboutme" >
                                    Products<?=($this->stat['cntProducts']>0?' ('.$this->stat['cntProducts'].') ':'')?>
                                </a>
                            </li>
                            <?php if($this->stat['cntFProducts']>0){ ?>
                            <li role="presentation">
                                <a href="#user-featuredproducts" data-toggle="tab" role="tab"  aria-controls="user-featuredproducts" >
                                    Featured<?=' ('.$this->stat['cntFProducts'].') '?>
                                </a>
                            </li>
                            <?php }?>
                             
                            <li>
                                <a href="#user-comments" data-toggle="tab" role="tab"  aria-controls="user-comments">
                                    Comments (<?=$this->comments->getTotalItemCount()?>)
                                </a>
                            </li>
                            <?php if(count($this->rated)>0){ ?>
                            <li>
                                <a href="#user-rated" data-toggle="tab" role="tab"  aria-controls="user-rated">
                                    Rated (<?=count($this->rated)?>)
                                </a>
                            </li>
                            <?php } ?>
                             <?php if($this->likes->getTotalItemCount()>0){ ?>
                            <li>
                                <a href="#user-favs" data-toggle="tab" role="tab"  aria-controls="user-favs">
                                    Favs (<?=$this->likes->getTotalItemCount()?>)
                                </a>
                            </li>
                          <?php } ?>

                          <?php if( $this->plings->getTotalItemCount()>0){ ?>
                            <li>
                                <a href="#user-plings" data-toggle="tab" role="tab"  aria-controls="user-plings">
                                    Plinged (<?=$this->plings->getTotalItemCount()?>)
                                </a>
                            </li>
                          <?php } ?>

                          <?php if( $this->supportersplings->getTotalItemCount()>0){ ?>
                            <li>
                                <a href="#supporters-plings" data-toggle="tab" role="tab"  aria-controls="supporters-plings">
                                    Supporters (<?=$this->supportersplings->getTotalItemCount()?>)
                                </a>
                            </li>
                          <?php } ?>
                          
                        </ul>
                        </div>
                        <!-- /tabs nav -->

                        <!-- tab panels -->

                        <div class="tab-content">

                            <div role="tabpanel" class="tab-pane active" id="user-aboutme">
                                <?php if ($this->userProducts) { ?>                                
                                     <div class="my-products-list" id="my-products-list">                                                                       
                                        <?php echo $this->render('user/partials/aboutme-products.phtml'); ?>                                       
                                    </div>
                                <?php } ?>
                            </div>

                            <?php if($this->stat['cntFProducts']>0){ ?>
                                <div role="tabpanel" class="tab-pane " id="user-featuredproducts">
                                    <?php 
                                           $this->userProducts = $this->userFeaturedProducts;
                                           $this->projectpage = 1;
                                           $this->total_records=0;
                                        if ($this->userProducts) { ?>                                
                                         <div class="my-products-list" id="my-products-list">                                                                       
                                            <?php echo $this->render('user/partials/aboutme-products.phtml'); ?>                                       
                                        </div>
                                    <?php } ?>
                                </div>
                             <?php } ?>
   
                            <div  role="tabpanel" class="tab-pane " id="user-comments">                                    
                                  <?php echo $this->render('user/partials/loopMyComments.phtml'); ?>
                            </div>

                             <?php if($this->likes->getTotalItemCount()>0){ ?>
                            <div  role="tabpanel" class="tab-pane " id="user-favs">       
                                    <div class="my-fav-list">                                                                   
                                  <?php echo $this->render('user/partials/aboutme-likes.phtml'); ?>
                                  </div>
                            </div> 
                            <?php } ?>  

                            <?php if( $this->plings->getTotalItemCount()>0){ ?>
                            <div  role="tabpanel" class="tab-pane " id="user-plings">       
                                    <div class="my-fav-list">                                                                   
                                  <?php echo $this->render('user/partials/aboutme-plings.phtml'); ?>
                                  </div>
                            </div> 
                            <?php } ?>  

                            <?php if($this->supportersplings->getTotalItemCount()>0){ ?>
                            <div  role="tabpanel" class="tab-pane " id="supporters-plings">       
                                    <div class="my-fav-list">                                                                   
                                        <?php echo $this->render('user/partials/aboutme-supporters.phtml'); ?>       
                                  </div>
                            </div> 
                            <?php } ?>  


                             <?php if(count($this->rated)>0){ ?>
                            <div  role="tabpanel" class="tab-pane " id="user-rated">    
                                <div class="my-fav-list">                               
                                  <?php echo $this->render('user/partials/loopRated.phtml'); ?>
                                  </div>                               
                            </div>                         
                            <?php } ?>

                        </div>

                        <!-- /tab panels -->

                    </div>

                    <!-- /page content -->

                    <!-- side bar -->


                    <aside class="col-md-4 col-lg-4 col-sm-4 col-xs-12">
                        <?php if(Zend_Auth::getInstance()->hasIdentity() AND Zend_Auth::getInstance()->getIdentity()->roleName == 'admin') { ?>
                        <?php 
                            $scoreArray= $helperMemberScore->fetchScore($this->member->member_id);
                        ?>
                        <div class="col-container">
                            <div class="well details about">
                                <div>
                                    <span>Score: <?php echo $scoreArray['score']; ?> <div class="inline" style="margin-left:.2em;" data-placement="top" data-toggle="popover" title="Member Score" data-trigger="hover" data-html="true" data-content="The score is calculated from the following values:<br> <ul><li>Products: <?php echo $scoreArray['count_product'];?> * <?php echo $scoreArray['factor_prod'];?></li><li>Plings: <?php echo $scoreArray['count_pling'];?> * <?php echo $scoreArray['factor_pling'];?></li><li>Likes: <?php echo $scoreArray['count_like'];?> * <?php echo $scoreArray['factor_like'];?></li><li>Comments: <?php echo $scoreArray['count_comment'];?> * <?php echo $scoreArray['factor_comment'];?></li><li>Years of membership: <?php echo $scoreArray['count_years_membership'];?> * <?php echo $scoreArray['factor_year'];?></li><li>Spam-Reports: <?php echo $scoreArray['count_report_product_spam'];?> * <?php echo $scoreArray['factor_report_prod_spam'];?></li><li>Misuse-Reports: <?php echo $scoreArray['count_report_product_fraud'];?> * <?php echo $scoreArray['factor_report_prod_fraud'];?></li></ul>"><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span></div> </span>
                                </div>

                                <?php
                                
                                    if($this->stat['cntDuplicateSourceurl']>0)
                                    {
                                        echo '<span>Duplicates: '.$this->stat['cntDuplicateSourceurl'].'</span>';
                                    }
                                    
                                    echo '<br/><span>Email adress: '.$this->member->mail.' </span>';
                                    echo '<br/><span>Paypal adress: '.$this->member->paypal_mail.' </span>';
                                                                       
                                ?>
                            </div>
                        </div>
                        <?php } ?>
                        <div class="col-container">
                            <div class="well details about">
                                <h3>About me</h3>

                                <div>
                                    <?php echo isset($this->mainProject->description) ? nl2br(strip_tags($this->mainProject->description)): ''; ?>
                                </div>
                            </div>
                        </div>
                      
                        <div class="col-container">
                            <div class="well details">
                                <h3>Connected Acounts</h3>

                                <div class="box-content">

                                    <div class="info-div">
                                        <div class="label">
                                            <img src="/images_sys/gitlab.png" class="accounts_icon">
                                        </div>
                                        <div class="text">
                                    
                                            <a href="<?= $url_gitlab ?>/<?php echo $this->member->username;?>">
                                            <span style="font-size: 16px; font-weight: normal;">
                                                <?php 
                                                $cntGitp = 0;
                                                if(!empty($this->member->gitlab_user_id)) {
                                                $gitlab = new Default_Model_Ocs_Gitlab();
                                                $gitProjects = $gitlab->getUserProjects($this->member->gitlab_user_id);
                                                $cntGitp = count($gitProjects);               
                                                }
                                                $gittext = $this->member->username . ' on git-opendesktop';
                                                if($cntGitp>0){
                                                    $gittext = $gittext.' ('.$cntGitp.')';
                                                }
                                                echo $gittext;
                                                ?> 
                                            </span>
                                            </a>
                                        </div>
                                    </div>

                                    <?php if (isset($this->member->link_github) && $this->member->link_github != ''): ?>
                                        <div class="github">
                                            <div class="label">                                               
                                                <img src="/theme/flatui/img/social_icons/github.png" class="accounts_icon">
                                            </div>
                                            <div class="text">
                                                <a href="<?php echo 'https://github.com/'.$this->member->link_github; ?>" target="_blank"><?php echo $this->member->link_github; ?></a>
                                            </diV>
                                        </div>
                                    <?php endif; ?>

                                     <?php if (false === empty($this->member->link_website)): ?>
                                        <div class="info-div">
                                            <div class="label">
                                                    <span class="glyphicon glyphicon-globe" style="color:#000"></span>
                                            </div>
                                            <div class="text">
                                           <a
                                                    href="<?php echo $helperAddDefaultScheme->addDefaultScheme($this->member->link_website); ?>"
                                                    target="_NEW"
                                                    title="<?php echo $helperAddDefaultScheme->addDefaultScheme($this->member->link_website); ?>"
                                                ><?php echo $this->member->link_website; ?></a>
                                                </div>
                                        </div>
                                    <?php endif; ?>

                                    <?php if (isset($this->member->link_facebook) && $this->member->link_facebook != ''):
                                        $helpFaceBookUrl = new Default_View_Helper_FacebookLink();
                                        $facebookLink = $helpFaceBookUrl->facebookLink($this->member->link_facebook);
                                        ?>
                                        <div class="facebook">
                                            <div class="label">
                                                
                                                 <img src="/theme/flatui/img/social_icons/fb.png" class="accounts_icon">
                                            </div>
                                            <div class="text">
                                                <a href="<?php echo $facebookLink; ?>"><?php echo $helperTruncate->truncate($this->member->link_facebook,
                                                        50); ?></a>
                                            </div>
                                        </div>
                                    <?php endif; ?>
                                    <?php if (isset($this->member->link_twitter) && $this->member->link_twitter != ''):
                                        $helpTwitterLink = new Default_View_Helper_TwitterLink();
                                        $twitterLink = $helpTwitterLink->twitterLink($this->member->link_twitter);
                                        ?>
                                        <div class="twitter">
                                            <div class="label">
                                               
                                                <img src="/theme/flatui/img/social_icons/tw.png" class="accounts_icon">
                                            </div>
                                            <div class="text">
                                                <a href="<?php echo $twitterLink; ?>"
                                                   target="_NEW"><?php echo $helperTruncate->truncate($this->member->link_twitter, 50); ?></a>
                                            </div>
                                        </div>
                                    <?php endif; ?>
                                    <?php if (isset($this->member->link_google) && $this->member->link_google != ''): 
                                    $helpTwitterLink = new Default_View_Helper_GoogleplusLink();
                                    $googleplusLink = $helpTwitterLink->googleplusLink($this->member->link_google);
                                    ?>
                                        <div class="google">
                                            <div class="label">
                                               
                                                <img src="/theme/flatui/img/social_icons/g_plus.png" class="accounts_icon">
                                            </div>
                                            <div class="text">
                                                <a href="<?php echo $googleplusLink ?>"><?php echo $helperTruncate->truncate($this->member->link_google,
                                                        50); ?></a>
                                            </diV>
                                        </div>
                                    <?php endif; ?>

                                    <?php 
                                        $helpFaceBookUrl = new Default_View_Helper_FacebookLink();
                                        $facebookLink = $helpFaceBookUrl->facebookLink($this->member->link_facebook);
                                    ?>
                                        <div class="email">
                                            <div class="label">
                                               
                                                <img src="/theme/flatui/img/social_icons/fb.png" class="accounts_icon">
                                            </div>
                                            <div class="text">
                                                  <a href="<?php echo $facebookLink; ?>"><?php echo $helperTruncate->truncate($this->member->link_facebook,
                                                        50); ?></a>
                                            </diV>
                                        </div> 

                                        <div class="email">
                                            <div class="label">
                                               
                                                <img src="/theme/flatui/img/email.png" class="accounts_icon">
                                            </div>
                                            <div class="text">
                                                <a href="<?= $url_forum ?>/u/<?=$this->member->username?>">Send Message</a>
                                            </diV>
                                        </div>

                                    
                                </div>
                            </div>
                        </div>
                      
                         
                    </aside>

                    <!-- side bar -->

                </section>

                <!-- /PAGE BODY -->

            </section>

        </section>

          <div class="tooltip_templates" style="display: none">
            <span id="tooltip_content">
                <i class="fa fa-spinner"></i>
            </span>
        </div>
    </main>
<?php $this->inlineScript()->appendScript(
    '    $(document).ready(function(){
            InitActiveHashTab.setup();
            AboutMeMyProjectsPaging.setup();
            AboutMeMyProjectsPagingButton.setup();        
            TooltipUser.setup("tooltipuser","right");   
            $(\'[data-toggle="popover"]\').popover();
        });
    ');

