<?php
/**
 *  ocs-webserver
 *
 *  Copyright 2016 by pling GmbH.
 *
 *    This file is part of ocs-webserver.
 *
 *    This program is free software: you can redistribute it and/or modify
 *    it under the terms of the GNU Affero General Public License as
 *    published by the Free Software Foundation, either version 3 of the
 *    License, or (at your option) any later version.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU Affero General Public License for more details.
 *
 *    You should have received a copy of the GNU Affero General Public License
 *    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 **/


$helperUserRole = new Backend_View_Helper_UserRole();
$userRoleName = $helperUserRole->userRole();
   
$fileName = $this->file_name;
$lastIndex = strripos($fileName, '.');
$fileExt = "";
if(!empty($lastIndex)) {
    $fileExt = substr($fileName, $lastIndex+1);
}
$fileExt = strtoupper($fileExt);
$isAppimage = false;
if($fileExt == 'APPIMAGE') {
    $isAppimage = true;
}

$isExternal = ($this->is_external == "true");

$hasTorrent = ($this->has_torrent == "true" || $this->has_torrent == "1");

$link = "";

if($isExternal) {
    $link = $this->external_link;
}    
?>
<!DOCTYPE html>
<html>
<head>
    <title>Download/Install</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <link href="tools/spectre/spectre.css" rel="stylesheet" type="text/css"/>
    <link href="tools/spectre/spectre-icons.css" rel="stylesheet" type="text/css"/>
    <link href="tools/spectre/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/theme/flatui/css/fontawsome/font-awesome.min.css"  crossorigin="anonymous">
    
    <style>
        .btn.btn-lg {
            font-size: 1.6rem;
            height: 4rem;
            padding: .9rem .8rem;
        }
        
        .btn span.icon {
            background: url(/images_sys/external_link_blue.png) no-repeat;
            background-size: cover;
            float: left;
            width: 18px;
            height: 18px;
            margin-right: 5px;
        }
        
        .btn:hover span.icon {
            background: url(/images_sys/external_link_white.png) no-repeat;
            background-size: cover;
            float: left;
            width: 18px;
            height: 18px;
            margin-right: 5px;
        }
        
        .btn {
            background-color: #0088d7;
            color: #ffffff;
        }
        
        .supporter-section .user figure {
            width: 100%;
            padding: 0;
            margin: 0;
        }
        
        .supporter-section .user figure img {
            width: 60px;
            border: 1px solid #dbdbdb;
            -webkit-border-radius: 999px;
            -moz-border-radius: 999px;
            border-radius: 999px;
            -webkit-background-clip: padding-box;
            -moz-background-clip: padding;
            background-clip: padding-box;
        }
        
    </style>
    
    <script type="text/javascript">
        function viewport()
        {
            var e = window
            , a = 'inner';
            if ( !( 'innerWidth' in window ) )
            {
            a = 'client';
            e = document.documentElement || document.body;
            }
            return { width : e[ a+'Width' ] , height : e[ a+'Height' ] }
        }
    </script>   
    
    
    <?php if (Default_Model_DbTable_MemberRole::ROLE_NAME_ADMIN == $userRoleName && $hasTorrent == true) { ?>
    
    <script src="/theme/flatui/js/lib/webtorrent.min.js"></script>
    <script>
        
        $(document).ready(function(){
            
       
            var client = new WebTorrent()
            client.on('error', function (err) {
                console.error('ERROR: ' + err.message)                                    
            })



            $('#form-download-torrent').on('submit', function (e) {
                e.preventDefault() // Prevent page refresh

                console.log('Start Torrent DL');

                <?php
                $config = Zend_Registry::get('config');
                $torrenturl = $config->torrent->media->downloadurl . "?id=".$this->file_id."&lt=torrent";
                ?>

                var torrentUrl = '<?= $torrenturl ?>';

                console.log('Url: ' + torrentUrl);
                //log('Adding ' + torrentId)
                client.add(torrentUrl, onTorrent);
            })

            function onTorrent (torrent) {
                console.log('onTorrent...');
                // // Print out progress every 5 seconds
                var interval = setInterval(function () {
                log('Progress: ' + (torrent.progress * 100).toFixed(1) + '%')
                }, 1000)

                torrent.on('done', function () {
                    //log('Progress: 100%');
                    log('Progress: 100%');
                    clearInterval(interval);
                })

                // Render all files into to the page
                torrent.files.forEach(function (file) {
                    //file.appendTo('.log')
                    //log('(Blob URLs only work if the file is loaded from a server. "http//localhost" works. "file://" does not.)')
                    file.getBlobURL(function (err, url) {
                        if (err) return log(err.message);
                        //log('File done.')
                        //log('<a href="' + url + '">Download full file: ' + file.name + '</a>');
                        window.location.assign(url);
                    })
                })
            }

            function log (str) {
                //var p = document.createElement('p')
                //p.innerHTML = str
                //document.querySelector('.log').appendChild(p)
                $('.log').innerHTML = str;
                console.log(str);
            }
        });
    </script>
    
    <?php } ?>    
    
</head>

<body style="height: 370px; background-color: #f8f9fa;">
    <main id="ads-page">
        
        <div class="columns" style="background-color: #f8f9fa;">
            <div class="col-8 col-md-12 col-xs-12 col-sm-12 column">
                <div class="toast toast-success" style="margin-bottom: 10px; background-color: #727e96 !important; border-color: #727e96 !important;">
                    <?php if($isExternal) { ?>
                    Click button below to follow external link.
                    <?php } else if($this->link_type == 'download') { ?>
                    Download prepared successfully, click the button below to start.
                    <?php } else { ?>
                    Installation prepared successfully, click the button below to start.
                    <?php } ?>
                    
                </div>
                <section class="empty">
                    <?php /*
                        if($isExternal == true) {
                    ?>
                    <div class="empty-icon">
                        <i class="fa fa-external-link"></i>
                    </div>
                    <?php
                        }*/
                    ?>
                    
                    <h1 class="empty-title"><?= $this->project_title ?></h1>
                    
                    
                    <div class="empty-action" style="height: 50px;">
                        
                        <?php
                        if ($_SERVER['REQUEST_METHOD'] == 'POST') { 
                            //echo '<a href="'.$this->url.'">Please click here</a>';
                            echo '<script>top.location.href = "'.$this->url.'"; parent.jQuery.fancybox.close();</script>';

                        } else {
                        ?>
                        
                            
                            
                        <?php if (Default_Model_DbTable_MemberRole::ROLE_NAME_ADMIN == $userRoleName && $hasTorrent == true) {                      
                        ?>

                            <form id="form-download-torrent" name="form-download-torrent">
                                Torrent-Download: 
                                <?php if($this->link_type == 'download') { ?>
                                <button type="submit" value="Continue Download" class="btn btn-success btn-lg" style="margin: 0 0 10px;">Download (<?= $this->file_size_human ?>)</button>
                                <?php } else { ?>
                                <button type="submit" value="Continue Installation" class="btn btn-success btn-lg" style="margin: 0 0 10px;">Install (<?= $this->file_size_human ?>)</button>
                                <p style="margin: 0;">*Install things with <a href="https://www.opendesktop.org/p/1136805/" target="_NEW" style="color: #0088d7;text-decoration: underline;">ocs-url</a> or <a href="https://www.opendesktop.org/p/1175480/" target="_NEW" style="color: #0088d7;text-decoration: underline;">ocs-store</a>.</p>
                                <?php } ?>
                            </form>

                            <div class="log"></div>

                        <?php } else { ?>    
                            <form id="Form1" name="Form1" action="" method="POST">
                            <?php if($isExternal && $this->link_type == 'download') {?>
                               <button type="submit" value="External Link" class="btn btn-success btn-lg" style="margin: 0 0 10px;">Follow Link (<?= $this->file_size_human ?>) <i class="fa fa-external-link"></i></button>   
                            <?php } else if($isExternal && $this->link_type == 'install') { ?>
                                <button type="submit" value="Continue Installation" class="btn btn-success btn-lg" style="margin: 0 0 10px;">Install (<?= $this->file_size_human ?>)</button>
                                <p style="margin: 0;">*Install things with <a href="https://www.opendesktop.org/p/1136805/" target="_NEW" style="color: #0088d7;text-decoration: underline;">ocs-url</a> or <a href="https://www.opendesktop.org/p/1175480/" target="_NEW" style="color: #0088d7;text-decoration: underline;">ocs-store</a>.</p>
                            <?php } else if($this->link_type == 'download') { ?>
                                <button type="submit" value="Continue Download" class="btn btn-success btn-lg" style="margin: 0 0 10px;">Download (<?= $this->file_size_human ?>)</button>
                            <?php } else { ?>
                                <button type="submit" value="Continue Installation" class="btn btn-success btn-lg" style="margin: 0 0 10px;">Install (<?= $this->file_size_human ?>)</button>
                                <p style="margin: 0;">*Install things with <a href="https://www.opendesktop.org/p/1136805/" target="_NEW" style="color: #0088d7;text-decoration: underline;">ocs-url</a> or <a href="https://www.opendesktop.org/p/1175480/" target="_NEW" style="color: #0088d7;text-decoration: underline;">ocs-store</a>.</p>
                            <?php } ?>

                            <?php
                            if($isExternal) {
                                echo("<p style='margin: 0;'>".$link."</p>");
                            }
                            if($isAppimage) {
                                echo("<p style='margin: 0;'>For Appimages we recommend <a href='https://www.opendesktop.org/p/1228228' target='_NEW' style='color: #0088d7;text-decoration: underline;'>AppImageLauncher</a> for system integration</p>");
                            }
                            ?>
                        <?php } ?>  
                         
                         <?php
                        }
                         ?>

                            </form>   
                        
                        
                    </div>

                    <div class="supporter-section" style="<?= ($isExternal?'margin-top: 100px;':'margin-top: 70px') ?>"> 
                        <span>
                            This download is made possible by supporters like
                            <div class="user">
                                <a target="_NEW" href="<?php echo $this->buildMemberUrl($this->supporter['username']); ?>" class="tooltipuser" data-tooltip-content="#tooltip_content" data-user="<?=$this->supporter['member_id']?>">
                                    <figure >
                                        <img width="" src="<?php echo $this->Image($this->supporter['profile_image_url'], array('width' => '200', 'height' => '200', 'crop' => 2)); ?>"/>
                                    </figure>
                                    <p><?php echo Default_Model_HtmlPurify::purify($this->supporter['username']); ?></p>                                                   
                                </a>
                            </div>
                        </span>
                    </div>
                    
                    
                    <div class="empty-action" style="height: 100px;">
                        <!--
                        <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
                        <input type="hidden" name="cmd" value="_s-xclick">
                        <input type="hidden" name="hosted_button_id" value="MYAVVME9CMX28">
                        <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" name="submit" alt="PayPal - The safer, easier way to pay online!" border="0">
                        <img alt="" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1" border="0">
                        </form>
                        -->
                        <br>
                        
                            <?php 
                                    $config = Zend_Registry::get('config')->settings->client->default;
                                    $baseurlStore = $config->baseurl_store;
                                    $identity = Zend_Auth::getInstance()->getIdentity();
                            ?>
                        <p style="font-size: 18px; position: absolute; bottom: 0px; width: 100%; left: 0%;">
                        <form action="<?= $baseurlStore ?>/support-predefined" method="POST" id="support_form_predefined" name="support_form_predefined" target="_parent">
                            <input type="hidden" name="section_id" value="<?= $this->section_id ?>">
                            <input type="hidden" name="project_id" value="<?= $this->project_id ?>">
                            Become a <a onclick="support_form_predefined.submit();" target="_NEW" style="color: #0088d7;text-decoration: underline; cursor: pointer;">Supporter</a>.
                        </form>
                            
                        </p>
                    </div>
                </section>
            </div>
        </div>
    </main>

</body>
<script>
        if(viewport()['width']<600 && "<?= $this->is_external ?>" === "true") {
            document.body.style = 'height: 500px; background-color: #f8f9fa;';
        }
    
    </script>
</html>

